# 基于DDD开发fastapi项目
*开发流程概览*  
![](流程.svg)

**核心功能**  
-[x] 用户登录  
-[x] 订单查询  
-[x] DDD分层架构  

在使用 FastAPI 构建中大型项目时，采用 **领域驱动设计（Domain-Driven Design, DDD）** 的分层结构有助于提高代码的可维护性、可测试性和业务逻辑的清晰度。DDD 通常将系统划分为以下几层：

1. **Domain（领域层）**：核心业务逻辑、实体（Entity）、值对象（Value Object）、领域服务（Domain Service）、仓储接口（Repository Interface）等。
2. **Application（应用层）**：用例（Use Cases）、应用服务（Application Service）、协调领域层与外部交互，不包含具体业务规则。
3. **Infrastructure（基础设施层）**：实现领域层定义的接口（如数据库、消息队列、第三方 API 等），以及框架相关代码（如 FastAPI 路由、依赖注入等）。
4. **Presentation / API（表现层）**：FastAPI 路由、请求/响应模型（Pydantic Schema）、异常处理等。

---

### 📁 推荐的 FastAPI + DDD 项目目录结构示例

```text
my_fastapi_app/
│
├── app/                              # 应用主目录
│   ├── __init__.py
│   │
│   ├── domain/                       # 领域层：纯业务逻辑，无任何框架依赖
│   │   ├── __init__.py
│   │   ├── models/                   # 领域实体（Entity）、值对象（VO）
│   │   │   ├── __init__.py
│   │   │   ├── user.py               # User 实体
│   │   │   └── order.py
│   │   │
│   │   ├── services/                 # 领域服务（含业务规则）
│   │   │   ├── __init__.py
│   │   │   └── user_service.py
│   │   │
│   │   └── repositories/             # 仓储接口（抽象，非实现！）
│   │       ├── __init__.py
│   │       ├── user_repository.py    # 定义 UserRepository 接口（如 ABC 抽象基类）
│   │       └── order_repository.py
│   │
│   ├── application/                  # 应用层：用例协调，调用领域层
│   │   ├── __init__.py
│   │   ├── use_cases/                # 应用用例（如创建用户、下单）
│   │   │   ├── __init__.py
│   │   │   ├── create_user.py
│   │   │   └── place_order.py
│   │   │
│   │   └── dto/                      # 数据传输对象（DTO）或命令/查询模型
│   │       ├── __init__.py
│   │       ├── create_user_dto.py
│   │       └── user_response_dto.py
│   │
│   ├── infrastructure/               # 基础设施层：实现细节
│   │   ├── __init__.py
│   │   ├── database/                 # 数据库连接、ORM 模型（如 SQLAlchemy）
│   │   │   ├── __init__.py
│   │   │   ├── session.py            # DB 会话管理
│   │   │   └── models/               # ORM 映射模型（与 domain.models 分离）
│   │   │       ├── __init__.py
│   │   │       ├── user.py
│   │   │       └── order.py
│   │   │
│   │   ├── repositories/             # 仓储接口的具体实现
│   │   │   ├── __init__.py
│   │   │   ├── user_repository_impl.py  # 实现 domain.repositories.user_repository
│   │   │   └── order_repository_impl.py
│   │   │
│   │   └── external/                 # 第三方服务集成（如邮件、支付）
│   │       ├── __init__.py
│   │       └── email_service.py
│   │
│   └── presentation/                 # 表现层：FastAPI 路由和 Schema
│       ├── __init__.py
│       ├── api/                      # API 路由
│       │   ├── __init__.py
│       │   ├── v1/
│       │   │   ├── __init__.py
│       │   │   ├── users.py          # 用户相关路由
│       │   │   └── orders.py
│       │   └── deps.py               # 依赖注入（如 get_user_repository）
│       │
│       └── schemas/                  # Pydantic 模型（请求/响应）
│           ├── __init__.py
│           ├── user_schema.py
│           └── order_schema.py
│
├── main.py                           # FastAPI 应用入口
├── settings.py                       # 配置（如环境变量）
├── pyproject.toml                    # 项目配置和依赖管理
├── requirements.txt
└── tests/                            # 测试目录（可按层划分）
```

---

### 🔍 各层职责说明

| 层级 | 职责 | 依赖方向 |
|------|------|--------|
| **Domain** | 核心业务逻辑、实体、领域服务、仓储接口 | 不依赖其他层（最内层） |
| **Application** | 编排用例、调用领域服务、处理事务边界 | 依赖 Domain |
| **Infrastructure** | 实现 Domain 中定义的接口（如数据库、邮件） | 依赖 Domain 和 Application |
| **Presentation** | HTTP 请求处理、序列化、路由 | 依赖 Application 和 Infrastructure |

> ✅ **依赖规则**：外层依赖内层，内层**绝不**依赖外层（依赖倒置原则）。

---

### 💡 小贴士

- 使用 **依赖注入（DI）** 将 `Infrastructure` 中的实现注入到 `Application` 层（通过 `deps.py`）。
- `domain.models` 是纯 Python 对象（POPO），不应包含 ORM 或 Pydantic 依赖。
- `infrastructure.database.models` 是 ORM 模型（如 SQLAlchemy），用于映射数据库。
- 在 `presentation.schemas` 中使用 Pydantic 模型进行数据校验和序列化。
- 可引入 `UnitOfWork` 模式管理事务（放在 `infrastructure` 或 `application`）。

---

如果你有具体的业务场景（如电商、博客等），我可以提供更针对性的结构建议。