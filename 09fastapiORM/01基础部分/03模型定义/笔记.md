## 模型定义  
> 分为三个部分
> 数据表模型定义
> 模型字段验证器
> 模型元数据
> 



### 模型字段验证器
```python
def validate_age(value):
    if value < 0:
        raise ValueError('Age must be greater than or equal to 0')

```
### 数据表模型定义
```python
from tortoise.models import Model
from tortoise.fields import CharField,IntField,DecimalField,DatetimeField,BooleanField
from tortoise.validators import Validator
class User(Model):
    id = IntField(primary_key=True)  # tips:uuid主键 其中主键可以写为pk=True
    username = CharField(max_length=20, unique=True)
    address = CharField(max_length=30, null=True)  # tips:null=True   代表可以为空
    email = CharField(max_length=255, unique=True,index=True)
    age = IntField(validators=[validate_age])  # tips:使用我们自己定义的验证, important  注意，列表中可以传入多个验证规则
    is_active = BooleanField(default=True)
    salary = DecimalField(gt=0, max_digits=10, decimal_places=2)  # tips:最大10位数,包含两位小数 gt=0表示要大于0
    created_at = DatetimeField(auto_now_add=True)  # 创建时间 tips  仅首次保存1记录时间
    updated_at = DatetimeField(auto_now=True)  # tips:auto_now 保存时更新

    # secrets_key=JSONField(null=True,encoder=JSONEncoder,decoder=JSONDecoder)  tips:存储字典或列表,可以自定义编码器和解码器

```


### 模型元数据
```python
    class Meta:
        table = 'employee'  # tips:自定义表的名称
        ordering = ['-created_at']  # tips:默认创建时间倒序排序
        indexes = [('email')] #tips:为邮件字段创建索引,也可以直接在模型定义中直接写参数index=True
        unique_together = (('username', 'email'),)  #tips:定义联合唯一约束,一个用户只能绑定一个邮箱地址

    def __str__(self):
        return self.username

```

###   本次采用了规范点的写法

目录如下
![img.png](img.png)


aerichconfig.py写的是数据库配置
```python
# @Time    : 2025/12/22 10:19
# @Author  : hero
# @File    : aerichconfig.py
from fastapi import FastAPI
from typing import Dict

# tips:数据库配置 非常像django中的写法
Tortoise_orm: Dict = {
    'connections': {
        'default': 'mysql://niko:HHCzio20@localhost:3306/fastapidb'

    },
    'apps': {
        'models': {
            # 'models': ['app.models', 'aerich.models'],  # tips 模型板块和Aerich迁移模型
            'models': ['app.usermodel', 'aerich.models'],  # tips 模型板块和Aerich迁移模型,这里使用我自己写的usermodel
            'default_connection': 'default',  # tips:指定使用我们上面定义的默认数据库连接
        }
    },
    # important:连接池配置(推荐)
    'use_tz': False,  # 是否使用时区
    'timezone': 'UTC',  # 默认时区
    'db_pool': {
        'max_size': 10,  # 最大连接数
        'min_size': 1,  # 最小连接数
        'idle_timeout': 30,  # 空闲连接超时(秒)
    }
}

```
>⚠️注意 我在本示例中是要将数据migrations在项目根目录下而不是app文件夹下，所以对于 
> `'models': ['app.usermodel', 'aerich.models'], ` 一定是要以根目录开始写
> 所以写成app.usermodel  


main.py
> 从数据库配置文件中倒入我们的配置字典
> 并使用tortoise的注册方式将其注册于app
```python
from fastapi import FastAPI
from .aerichconfig import Tortoise_orm
from tortoise.contrib.fastapi import register_tortoise
app = FastAPI()

register_tortoise(
    app,
    config=Tortoise_orm,
    generate_schemas=True,
    add_exception_handlers=True
)

```

--- 
接下来的迁移操作一定要注意好
```bash
(.venvs) nikofox@MOSS:~/fastapi_learn/09fastapiORM/01基础部分/03模型定义$ aerich init -t app.aerichconfig.Tortoise_orm
Success writing aerich config to pyproject.toml
Success creating migrations folder ./migrations

(.venvs) nikofox@MOSS:~/fastapi_learn/09fastapiORM/01基础部分/03模型定义$ aerich init-db
/home/nikofox/fastapi_learn/.venvs/lib/python3.12/site-packages/aiomysql/cursors.py:158: Warning: Table 'aerich' already exists
  while (await self.nextset()):
Success creating app migration folder migrations/models
Success generating initial migration file for app "models"
Success writing schemas to database "fastapidb"
```


一定要注意写法，不然就会迁移失败，而且配置中的model一定是从你当前目录(一般是项目根目录)
开始,不然就会遇到这样的错误:
```bash
 File "/home/nikofox/fastapi_learn/.venvs/lib/python3.12/site-packages/tortoise/__init__.py", line 352, in _init_apps
    cls.init_models(info["models"], name, _init_relations=False)
  File "/home/nikofox/fastapi_learn/.venvs/lib/python3.12/site-packages/tortoise/__init__.py", line 333, in init_models
    app_models += cls._discover_models(models_path, app_label)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/nikofox/fastapi_learn/.venvs/lib/python3.12/site-packages/tortoise/__init__.py", line 293, in _discover_models
    raise ConfigurationError(f'Module "{models_path}" not found')
tortoise.exceptions.ConfigurationError: Module "usermodel" not found

这个就是因为没有及时意识到应该写为app.usermodel   
因为我是在03模型定义文件下进行数据库迁移的而不是进入到app文件夹下进行迁移的
```