éå¸¸å¥½çš„é—®é¢˜ï¼FastAPI æœ¬èº«ä¸åƒ Flask é‚£æ ·å¼ºåˆ¶çº¦å®šé¡¹ç›®ç»“æ„ï¼Œä½†å®ƒæœ‰ **æ¨èçš„ç»„ç»‡æ–¹å¼**ï¼Œå°¤å…¶åœ¨ä½¿ç”¨æ•°æ®åº“ï¼ˆå¦‚ SQLAlchemy æˆ– Tortoise-ORMï¼‰å’Œå¤§å‹é¡¹ç›®æ—¶ã€‚ä¸‹é¢æˆ‘ä¼šä» **Flask å¼€å‘è€…çš„è§†è§’**ï¼Œå¯¹æ¯”è¯´æ˜ FastAPI çš„â€œæ ‡å‡†â€æˆ–â€œæœ€ä½³å®è·µâ€ç›®å½•ç»“æ„ï¼Œå¹¶é‡ç‚¹è§£é‡Šä½ å…³å¿ƒçš„ **æ•°æ®åº“åˆå§‹åŒ–ã€æ¨¡å‹ç»„ç»‡ã€å·¥å…·å‡½æ•°** ç­‰é—®é¢˜ã€‚

---

## âœ… ä¸€ã€FastAPI æ¨èçš„å…¸å‹é¡¹ç›®ç»“æ„ï¼ˆä¸­å¤§å‹é¡¹ç›®ï¼‰

```
my_fastapi_project/
â”œâ”€â”€ app/                     # ä¸»åº”ç”¨åŒ…ï¼ˆç±»ä¼¼ Flask çš„ apps/ï¼‰
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ main.py              # åˆ›å»º FastAPI å®ä¾‹ï¼ˆå…¥å£ï¼‰
â”‚   â”œâ”€â”€ core/                # æ ¸å¿ƒé…ç½®ã€å®‰å…¨ã€ä¾èµ–ç­‰
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ config.py        # é…ç½®ï¼ˆenv, database URL ç­‰ï¼‰
â”‚   â”‚   â””â”€â”€ security.py      # JWTã€å¯†ç å“ˆå¸Œç­‰
â”‚   â”œâ”€â”€ models/              # æ•°æ®åº“æ¨¡å‹ï¼ˆSQLAlchemy æˆ– Tortoiseï¼‰
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ user.py
â”‚   â”‚   â””â”€â”€ item.py
â”‚   â”œâ”€â”€ schemas/             # Pydantic æ¨¡å‹ï¼ˆè¯·æ±‚/å“åº”ä½“ï¼‰
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ user.py
â”‚   â”‚   â””â”€â”€ item.py
â”‚   â”œâ”€â”€ api/                 # API è·¯ç”±ï¼ˆv1, v2...ï¼‰
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ v1/
â”‚   â”‚       â”œâ”€â”€ __init__.py
â”‚   â”‚       â”œâ”€â”€ routes/
â”‚   â”‚       â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚       â”‚   â”œâ”€â”€ users.py
â”‚   â”‚       â”‚   â””â”€â”€ items.py
â”‚   â”‚       â””â”€â”€ deps.py      # ä¾èµ–æ³¨å…¥ï¼ˆå¦‚ get_db, get_current_userï¼‰
â”‚   â”œâ”€â”€ db/                  # æ•°æ®åº“ç›¸å…³ï¼ˆä¼šè¯ã€å¼•æ“ã€åˆå§‹åŒ–ï¼‰
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ session.py       # åˆ›å»º SessionLocal / engine
â”‚   â”‚   â””â”€â”€ base.py          # Base = declarative_base()
â”‚   â””â”€â”€ utils/               # å·¥å…·å‡½æ•°ï¼ˆé‚®ä»¶ã€æ–‡ä»¶å¤„ç†ç­‰ï¼‰
â”‚       â”œâ”€â”€ __init__.py
â”‚       â””â”€â”€ helpers.py
â”œâ”€â”€ alembic/                 # å¦‚æœç”¨ SQLAlchemy + Alembic åšè¿ç§»
â”œâ”€â”€ migrations/              # å¦‚æœç”¨ Tortoise + Aerich åšè¿ç§»
â”œâ”€â”€ tests/                   # æµ‹è¯•
â”œâ”€â”€ requirements.txt
â”œâ”€â”€ .env                     # ç¯å¢ƒå˜é‡
â””â”€â”€ pyproject.toml           # æˆ– setup.pyï¼ˆç”¨äº Aerich/Alembic é…ç½®ï¼‰
```

> è¿™ä¸ªç»“æ„å‚è€ƒäº† [FastAPI å®˜æ–¹æ•™ç¨‹](https://fastapi.tiangolo.com/tutorial/bigger-applications/) å’Œç¤¾åŒºæœ€ä½³å®è·µï¼ˆå¦‚ `full-stack-fastapi-postgresql` æ¨¡æ¿ï¼‰ã€‚

---

## âœ… äºŒã€å¯¹æ¯” Flaskï¼šFastAPI å¦‚ä½•â€œåˆå§‹åŒ–æ•°æ®åº“â€ï¼Ÿ

### ğŸ”¸ Flask æ–¹å¼ï¼ˆä½ ç†Ÿæ‚‰çš„ï¼‰ï¼š
```python
# utils/db_helper.py
from flask_sqlalchemy import SQLAlchemy
db = SQLAlchemy()

# app/__init__.py
from utils.db_helper import db
def create_app():
    app = Flask(__name__)
    db.init_app(app)
    return app
```

### ğŸ”¸ FastAPI æ–¹å¼ï¼ˆæ— å…¨å±€ appï¼Œç”¨ä¾èµ–æ³¨å…¥ï¼‰

FastAPI **æ²¡æœ‰å…¨å±€ `app` å¯¹è±¡**ï¼ˆè™½ç„¶å¯ä»¥åˆ›å»ºï¼Œä½†ä¸æ¨èï¼‰ï¼Œè€Œæ˜¯é€šè¿‡ **ä¾èµ–æ³¨å…¥ï¼ˆDependency Injectionï¼‰** æ¥ç®¡ç†æ•°æ®åº“ä¼šè¯ã€‚

#### ç¤ºä¾‹ï¼šä½¿ç”¨ SQLAlchemy

```python
# app/core/config.py
from pydantic_settings import BaseSettings

class Settings(BaseSettings):
    DATABASE_URL: str = "sqlite:///./test.db"

settings = Settings()
```

```python
# app/db/session.py
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker
from app.core.config import settings

engine = create_engine(settings.DATABASE_URL)
SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)
```

```python
# app/db/base.py
from sqlalchemy.ext.declarative import declarative_base
Base = declarative_base()
```

```python
# app/models/user.py
from sqlalchemy import Column, Integer, String
from app.db.base import Base

class User(Base):
    __tablename__ = "users"
    id = Column(Integer, primary_key=True)
    name = Column(String)
```

```python
# app/api/v1/deps.py ï¼ˆä¾èµ–é¡¹ï¼‰
from fastapi import Depends
from sqlalchemy.orm import Session
from app.db.session import SessionLocal

def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()
```

```python
# app/main.py
from fastapi import FastAPI, Depends
from app.api.v1.routes import users
from app.db.base import Base
from app.db.session import engine

# åˆ›å»ºè¡¨ï¼ˆä»…å¼€å‘ç”¨ï¼Œç”Ÿäº§ç”¨ Alembicï¼‰
Base.metadata.create_all(bind=engine)

app = FastAPI()
app.include_router(users.router, prefix="/api/v1")
```

```python
# app/api/v1/routes/users.py
from fastapi import APIRouter, Depends
from sqlalchemy.orm import Session
from app.api.v1.deps import get_db

router = APIRouter()

@router.get("/users/")
def read_users(db: Session = Depends(get_db)):
    # ä½¿ç”¨ db æŸ¥è¯¢
    return {"msg": "ok"}
```

> âœ… **å…³é”®åŒºåˆ«**ï¼š  
> - FastAPI **ä¸è°ƒç”¨ `db.init_app(app)`**ï¼Œè€Œæ˜¯é€šè¿‡ `Depends(get_db)` æ³¨å…¥æ¯ä¸ªè¯·æ±‚çš„æ•°æ®åº“ä¼šè¯ã€‚
> - æ•°æ®åº“å¼•æ“å’Œä¼šè¯åœ¨æ¨¡å—çº§åˆ«åˆ›å»ºï¼Œä½†æ¯ä¸ªè¯·æ±‚è·å¾—ç‹¬ç«‹ä¼šè¯ï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰ã€‚

---

## âœ… ä¸‰ã€å¦‚æœä½ ç”¨çš„æ˜¯ Tortoise-ORMï¼ˆåƒä½ ä¹‹å‰é‚£æ ·ï¼‰

Tortoise-ORM æ˜¯å¼‚æ­¥ ORMï¼Œå®ƒç¡®å®éœ€è¦ä¸€ä¸ª **é…ç½®å­—å…¸** å¹¶æ³¨å†Œåˆ° FastAPI åº”ç”¨ä¸Šï¼Œè¿™æ›´æ¥è¿‘ Flask çš„ `init_app` æ¨¡å¼ã€‚

### æ¨èç»“æ„ï¼š

```
app/
â”œâ”€â”€ main.py
â”œâ”€â”€ core/
â”‚   â””â”€â”€ config.py          # åŒ…å« TORTOISE_ORM é…ç½®å­—å…¸
â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ user.py            # Tortoise Model
â”‚   â””â”€â”€ aerich.py          # å¯é€‰ï¼šAerich æ¨¡å‹æ³¨å†Œ
â””â”€â”€ api/
    â””â”€â”€ v1/
        â””â”€â”€ users.py
```

### ç¤ºä¾‹ï¼š

```python
# app/core/config.py
TORTOISE_ORM = {
    "connections": {"default": "mysql://user:pass@localhost/db"},
    "apps": {
        "models": {
            "models": ["app.models.user", "aerich.models"],
            "default_connection": "default",
        }
    }
}
```

```python
# app/main.py
from fastapi import FastAPI
from tortoise.contrib.fastapi import register_tortoise
from app.core.config import TORTOISE_ORM

app = FastAPI()

register_tortoise(
    app,
    config=TORTOISE_ORM,
    generate_schemas=False,  # ç”Ÿäº§ç¯å¢ƒè®¾ä¸º Falseï¼Œç”¨ Aerich ç®¡ç†
    add_exception_handlers=True,
)
```

> âœ… è¿™é‡Œçš„ `register_tortoise(...)` å°±ç›¸å½“äº Flask çš„ `db.init_app(app)`ï¼

ç„¶åä½ è¿è¡Œ Aerich åˆå§‹åŒ–å‘½ä»¤æ—¶ï¼š

```bash
aerich init -t app.core.config.TORTOISE_ORM
```

å°±ä¸ä¼šæœ‰å‘½åå†²çªé—®é¢˜ã€‚

---

## âœ… å››ã€æ€»ç»“ï¼šFastAPI vs Flask çš„æ ¸å¿ƒå·®å¼‚

| åŠŸèƒ½ | Flask | FastAPI |
|------|-------|--------|
| å…¨å±€ app | æœ‰ (`app = Flask(__name__)`) | ä¸æ¨èï¼Œé€šå¸¸åªåœ¨ `main.py` åˆ›å»ºä¸€æ¬¡ |
| æ•°æ®åº“åˆå§‹åŒ– | `db.init_app(app)` | SQLAlchemyï¼šä¾èµ–æ³¨å…¥ï¼›Tortoiseï¼š`register_tortoise(app, config=...)` |
| æ¨¡å‹ä½ç½® | `models/` | åŒæ ·ç”¨ `models/` |
| å·¥å…·å‡½æ•° | `utils/` | åŒæ ·ç”¨ `utils/` |
| é…ç½®ç®¡ç† | `config.py` æˆ– `.env` | æ¨è `pydantic-settings` + `.env` |
| è¿ç§»å·¥å…· | Flask-Migrate (Alembic) | SQLAlchemy â†’ Alembicï¼›Tortoise â†’ Aerich |

---

## âœ… äº”ã€ç»™ä½ çš„å»ºè®®

1. **ä¸è¦ç”¨ `code.py`** â†’ æ”¹æˆ `config.py` æˆ– `settings.py`
2. **æŠŠæ¨¡å‹æ”¾åœ¨ `models/` ç›®å½•ä¸‹**
3. **Tortoise é…ç½®æ”¾åœ¨ `core/config.py` ä¸­**
4. **Aerich åˆå§‹åŒ–å‘½ä»¤å†™æˆ**ï¼š
   ```bash
   aerich init -t app.core.config.TORTOISE_ORM
   ```
5. **ä¸»ç¨‹åºå…¥å£æ˜¯ `main.py`ï¼ŒåŒ…å« `app = FastAPI()`**

---

å¦‚æœä½ å¸Œæœ›æˆ‘æ ¹æ®ä½ å½“å‰çš„é¡¹ç›®ï¼ˆ09fastapiORM/01åŸºç¡€éƒ¨åˆ†ï¼‰å¸®ä½ é‡æ„æˆæ ‡å‡†ç»“æ„ï¼Œæˆ‘å¯ä»¥ç›´æ¥ç»™ä½ æ”¹å†™åçš„æ–‡ä»¶å†…å®¹ ğŸ‘

éœ€è¦å—ï¼Ÿ