## è„šæœ¬æ–¹å¼æ·»åŠ æ•°æ®    

> æ•°æ®è¡¨å®šä¹‰å¦‚ä¸‹   
```python
# @Time    : 2025/12/22 10:19
# @Author  : hero
# @File    : usermodel.py
from json import JSONEncoder, JSONDecoder

from tortoise.fields import CharField, DatetimeField, BooleanField, IntField, DecimalField, JSONField
from tortoise.models import Model
from tortoise.validators import Validator
def validate_age(value):
    if value < 0:
        raise ValueError('Age must be greater than or equal to 0')
class  Student(Model):
    id = IntField(pk=True)
    name = CharField(max_length=50)
    email = CharField(max_length=100,unique=True,null=True,description='å­¦ç”Ÿé‚®ç®±,å”¯ä¸€')
    age = IntField(validators=[validate_age])
    class Meta:
        table='students'
        unique_together=(('name','email'))

    def __str__(self):
        return self.name

```
> âš ï¸æ³¨æ„ï¼å®šä¹‰äº†è”åˆå”¯ä¸€çº¦æŸï¼Œæ¯ä¸ªç”¨æˆ·ååªèƒ½æœ‰ä¸€ä¸ªé‚®ç®±åœ°å€ï¼Œæ¯ä¸ªé‚®ç®±åœ°å€åªèƒ½ç»‘å®šä¸€ä¸ªç”¨æˆ·


### æ•°æ®å¢åŠ è„šæœ¬  

```python
# @Time    : 2025/12/22 13:21
# @Author  : hero
# @File    : è„šæœ¬æ¨¡å¼.py


from tortoise import Tortoise,run_async
from  usermodel import Student
async def create_student(name:str,age:int=None,email:str=None):
   stu= await Student.create(name=name,age=age,email=email)#tips:å› ä¸ºæ˜¯å¼‚æ­¥æ“ä½œï¼Œæ‰€ä»¥å‰é¢è¦åŠ ä¸Šawait

   return stu

async def init():
    await Tortoise.init(
        db_url='mysql://niko:HHCzio20@localhost:3306/fastapidb',
        modules={
            'models': ['usermodel']#tips:æ³¨æ„è¿™é‡Œå¦‚æœæ˜¯å•é¡¹ç›®çš„è¯å°±uä¸ç”¨å†™app.usermodel
        }
    )

async def main():
    await init()
    stu1=await create_student(
        name='å¼ ä¸‰',
        age=18,
        email='zhangsan@qq.com'
    )
    print(f'åˆ›å»ºæˆåŠŸ{stu1.name},{stu1.email}')
    stu2=await create_student(
        name='æå››',
        age=21,
        email='lisi@qq.com'
    )
    print(f'åˆ›å»ºæˆåŠŸ{stu2.name},{stu2.email}')

    stu3=await create_student(
        name='ç‹äº”',
        age=22,
        email='lisi@qq.com' #tips:è¿™é‡Œå†™æ˜¯ä¸ºäº†æµ‹è¯•å”¯ä¸€çº¦æŸ
    )
    print(f'åˆ›å»ºæˆåŠŸ{stu3.name},{stu3.email}')

if __name__ == '__main__':
    run_async(main()) #tips:å› ä¸ºæ˜¯å¼‚æ­¥çš„ï¼Œæ‰€ä»¥è¦ç”¨å¼‚æ­¥çš„æ‰§è¡Œæ–¹å¼

```

è¿™é‡Œç”¨ç‹äº”æ¥æµ‹è¯•è”åˆå”¯ä¸€çº¦æŸçš„å…³ç³»ï¼Œè„šæœ¬è¿è¡Œåæœç„¶å‡ºé”™
```shell
åˆ›å»ºæˆåŠŸå¼ ä¸‰,zhangsan@qq.com
åˆ›å»ºæˆåŠŸæå››,lisi@qq.com
Traceback (most recent call last):
  ........
  File "/home/nikofox/fastapi_learn/.venvs/lib/python3.12/site-packages/tortoise/backends/mysql/client.py", line 60, in translate_exceptions_
    raise IntegrityError(exc)
tortoise.exceptions.IntegrityError: (1062, "Duplicate entry 'lisi@qq.com' for key 'students.email'")
```
> çœ‹é‡ç‚¹éƒ¨åˆ†ï¼Œæ•°æ®åº“å·²ç»è¯†åˆ«åˆ°æˆ‘ä»¬æœ‰é‡å¤çš„é‚®ç®±åœ°å€ ğŸ“«  
> ![img.png](img.png)

è¯´æ˜æˆ‘ä»¬å†™çš„çº¦æŸèµ·ä½œç”¨äº†


--- 

## å¢åŠ æ•°æ®æ¥å£æ–¹å¼  
```python
# @Time    : 2025/12/22 10:18
# @Author  : hero
# @File    : main.py
from fastapi import FastAPI,Form
from pydantic import BaseModel
from typing import Annotated
from aerichconfig import Tortoise_orm
from usermodel import Student
from tortoise.contrib.fastapi import register_tortoise
app = FastAPI()

register_tortoise(
    app,
    config=Tortoise_orm,
    generate_schemas=True,
    add_exception_handlers=True
)


#tips:æ¥å£æ–¹å¼
class Stu(BaseModel):
    name:str
    age:int
    email: str

@app.post('/stuadd')
async def adduser(stu:Annotated[Stu,Form()]):
    await Student.create(name=stu.name, age=stu.age, email=stu.email)
    return {
        'status':True,
        'message':f'Student{stu.name} successfully added'
    }


```

---
## åˆ é™¤è„šæœ¬ 
```python
async def  del_student(name:str):
    stu=await Student.filter(name=name).first()
    if not stu:
        return False
    await stu.delete()
    return True
```
## æ¥å£æ–¹å¼åˆ é™¤
```python
@app.delete('/stu', description='ä¼ å…¥å­¦ç”Ÿidå¯¹å…¶è¿›è¡Œåˆ é™¤')
async def get_stu(id: int):
    stu = await Student.get(id=id)
    if stu:
        await stu.delete()
        return {
            'status': True,
            'message': f'Student{stu.name} successfully retrieved'
        }

```
---

## æŸ¥è¯¢è„šæœ¬
```python
#tips:è·å–å•æ¡æ•°æ®
async def get_stu(id:int)->Student:
    stu = await Student.get(id=id)
    return stu

#tips:è·å–å¤šæ¡æ•°æ®
async def get_allstu(name:str)->list[Student]:
    allstu=await Student.filter(name=name).all()
    return allstu
#tips:è·å–æ‰€æœ‰æ•°æ®
async def get_allstu(id:int)->list[Student]:
    allstu  = await Student.all()
    return allstu
    

```
## æŸ¥è¯¢æ¥å£
```python
@app.get('/stu/{id}', response_model=Stu, description='æ ¹æ®IDæŸ¥è¯¢å•ä¸ªå­¦ç”Ÿ')
async def get_student_by_id(id: int):
    stu = await Student.get(id=id)
    return stu


@app.get('/stu', description='æŸ¥è¯¢å­¦ç”Ÿä¿¡æ¯', response_model=list[Stu])
async def get_stu():  # tips:ä¸€ä¸ªæŸ¥è¯¢å‚æ•°id,å¦‚æœè¾“å…¥å°±æŸ¥è¯¢å•ä¸ªå­¦ç”Ÿï¼Œå¦åˆ™æŸ¥è¯¢å¤šä¸ª

    allstu = await Student.all()
    return allstu
```

## ä¿®æ”¹è„šæœ¬
```python
async def update_student(id:int,name:str=None,age:int=None,email:str=None):
    stu=await Student.get(id=id)
    if not stu:
        return False
    else:
        if name:
            stu.name=name
        if age:
            stu.age=age
        if email:
            stu.email=email
        stu.save()
        return True


```
## ä¿®æ”¹æ¥å£
```python
class UpdateStudentForm(BaseModel):
    id: int
    name: Optional[str] = None
    age: Optional[int] = None
    email: Optional[str] = None


@app.patch('/stu', description='ä¿®æ”¹å­¦ç”Ÿä¿¡æ¯ï¼ˆä¼ å…¥ id å’Œè¦ä¿®æ”¹çš„å­—æ®µï¼‰')
async def update_stu(form: UpdateStudentForm):
    student = await Student.get_or_none(id=form.id)
    if not student:
        return {"status": False, "msg": "å­¦ç”Ÿä¸å­˜åœ¨"}

    # tipsï¼š åªæ›´æ–°å®¢æˆ·ç«¯å®é™…æä¾›çš„å­—æ®µï¼ˆæ’é™¤ id å’Œ None å€¼ï¼‰
    update_fields = form.model_dump(exclude_unset=True)
    update_fields.pop("id", None)

    if not update_fields:
        return {"status": True, "msg": "æ— å­—æ®µéœ€è¦æ›´æ–°"}

    await Student.filter(id=form.id).update(**update_fields)  # tips:è¿›è¡Œæ‰¹é‡æ›´æ–°

    updated = await Student.get(id=form.id)
    return {"status": True, "message": f"å­¦ç”Ÿ {updated.name} æ›´æ–°æˆåŠŸ", "data": updated}

```


## æ¨¡ç³ŠæŸ¥è¯¢
```python
#tips:æ¨¡ç³ŠæŸ¥è¯¢
async def get_student(name:str):
    stu=await Student.filter(name__contains=name)
    return stu
#tips:å¤šæ¡ä»¶æ¨¡ç³ŠæŸ¥è¯¢
async def get_allstudent(name:str,age:int)->list[Student]:
    stu=await Student.filter(name__contains=name,age=age).all()
    return stu

async def getstus():
    stus=await Student.filter(id__gt=1).all() #tipsï¼šæŸ¥è¯¢å­¦ç”Ÿid>1çš„æ‰€æœ‰å­¦ç”Ÿ
    return stus 
async def getsturange():
    stus=await Student.filter(id__range=[2,80]) #tips:æŸ¥è¯¢idä»2-80çš„æ‰€æœ‰å­¦ç”Ÿ
    return stus
async def getstuin():
    stus=await Student.filter(id__in=[2,3,89])   #tips:æŸ¥è¯¢idä¸º2,3,89çš„ä¸‰åå­¦ç”Ÿ
    return stus 

```

## å•åˆ—æ•°æ®æŸ¥è¯¢
```python
async def getname():
    stu=await Student.all().values('name')
    return stu #è¿”å›çš„æ˜¯ä¸€ä¸ªåˆ—è¡¨åŒ…å«çš„å­—å…¸
```
>  è¿”å›çš„ç±»å‹æ˜¯è¿™æ ·çš„[{'name':'xxx'},{'name':'xxx'}]
> 
## å¤šåˆ—æ•°æ®æŸ¥è¯¢
```python
async def getname():
    stu=await Student.all().values('name','age')
    return stu #è¿”å›çš„æ˜¯ä¸€ä¸ªåˆ—è¡¨åŒ…å«çš„å­—å…¸
```

>  è¿”å›çš„ç±»å‹æ˜¯è¿™æ ·çš„[{'name':'xxx','age':18},{'name':'xxx','age':34}]
