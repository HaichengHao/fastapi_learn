éå¸¸å¥½çš„é—®é¢˜ï¼ä½ é—®åˆ°äº† FastAPI + Pydantic ä¸­ **è¯·æ±‚ä½“è§£æã€æ•°æ®æ›´æ–°ã€å­—æ®µè¿‡æ»¤** çš„æ ¸å¿ƒæœºåˆ¶ã€‚æˆ‘ä»¬æ¥ä¸€æ­¥æ­¥è¯¦ç»†è§£é‡Šï¼š

---

## ğŸ§© 1. `form: UpdateStu` æ˜¯ä»€ä¹ˆï¼Ÿâ€”â€” è¯·æ±‚ä½“çš„è‡ªåŠ¨è§£æ

å½“ä½ å†™ï¼š
```python
async def update_student(stuid: int, form: UpdateStu):
```

FastAPI ä¼šè‡ªåŠ¨åšä»¥ä¸‹äº‹æƒ…ï¼š

- ä» HTTP è¯·æ±‚çš„ **bodyï¼ˆè¯·æ±‚ä½“ï¼‰** ä¸­è¯»å– JSON æ•°æ®ï¼ˆæ¯”å¦‚ `{"name": "æå››", "age": 20}`ï¼‰
- å°è¯•å°†è¿™ä¸ª JSON **éªŒè¯å¹¶è½¬æ¢æˆ `UpdateStu` æ¨¡å‹çš„å®ä¾‹**
- å¦‚æœéªŒè¯å¤±è´¥ï¼ˆæ¯”å¦‚ä¼ äº†éæ³•å­—æ®µã€ç±»å‹ä¸å¯¹ã€å¿…å¡«å­—æ®µç¼ºå¤±ï¼‰ï¼Œå°±è¿”å› 422 é”™è¯¯
- å¦‚æœæˆåŠŸï¼Œå°±æŠŠè¿™ä¸ª `UpdateStu` å¯¹è±¡èµ‹å€¼ç»™å˜é‡ `form`

âœ… æ‰€ä»¥ `form` å°±æ˜¯ä½ ä¼ è¿‡æ¥çš„æ•°æ®ï¼Œå·²ç»æ˜¯ä¸€ä¸ª **ç»“æ„åŒ–ã€ç±»å‹å®‰å…¨çš„ Python å¯¹è±¡**ã€‚

> ğŸ’¡ æ³¨æ„ï¼šè¿™é‡Œç”¨çš„æ˜¯ **JSON è¯·æ±‚ä½“**ï¼ˆContent-Type: application/jsonï¼‰ï¼Œä¸æ˜¯ Form è¡¨å•ã€‚  
> å¦‚æœä½ æƒ³ç”¨è¡¨å•ï¼ˆæ¯”å¦‚ HTML è¡¨å•æäº¤ï¼‰ï¼Œæ‰éœ€è¦ç”¨ `Form()`ã€‚ä½† PATCH/PUT é€šå¸¸ç”¨ JSONã€‚

---

## ğŸ§© 2. ä¸ºä»€ä¹ˆè¦ç”¨ `form.model_dump(exclude_unset=True)`ï¼Ÿ

### å…ˆçœ‹ä¸åŠ  `exclude_unset=True` çš„é—®é¢˜ï¼š

å‡è®¾ä½ åªä¼ äº†ï¼š
```json
{ "name": "ç‹äº”" }
```

é‚£ä¹ˆ `form` å¯¹è±¡å†…éƒ¨å…¶å®æ˜¯ï¼š
```python
UpdateStu(name="ç‹äº”", age=None, address=None)
```

å¦‚æœä½ ç›´æ¥éå†æ‰€æœ‰å­—æ®µï¼Œä¼šå¾—åˆ°ï¼š
```python
form.dict() 
# â†’ {'name': 'ç‹äº”', 'age': None, 'address': None}
```

è¿™æ—¶å€™å¦‚æœä½ æŠŠ `age=None` æ›´æ–°åˆ°æ•°æ®åº“ï¼Œå°±ä¼š **æŠŠå¹´é¾„æ¸…ç©ºä¸º NULL**ï¼è¿™æ˜¾ç„¶ä¸æ˜¯ä½ æƒ³è¦çš„ã€‚

---

### âœ… `exclude_unset=True` çš„ä½œç”¨ï¼š

å®ƒåªä¿ç•™ **å®¢æˆ·ç«¯å®é™…å‘é€çš„å­—æ®µ**ï¼Œå¿½ç•¥é‚£äº›â€œæ²¡ä¼ â€çš„å­—æ®µï¼ˆå³ä½¿æ¨¡å‹é‡Œæœ‰é»˜è®¤å€¼æˆ– Optionalï¼‰ã€‚

```python
form.model_dump(exclude_unset=True)
# â†’ {'name': 'ç‹äº”'}   â† åªæœ‰çœŸæ­£ä¼ äº†çš„å­—æ®µï¼
```

è¿™æ ·ä½ å°±èƒ½å®‰å…¨åœ°çŸ¥é“ï¼š**ç”¨æˆ·åªæƒ³æ”¹åå­—ï¼Œå…¶ä»–å­—æ®µä¸è¦åŠ¨**ã€‚

> ğŸ”” è¿™æ˜¯å®ç°â€œéƒ¨åˆ†æ›´æ–°ï¼ˆpartial updateï¼‰â€çš„å…³é”®ï¼

---

## ğŸ§© 3. ä¸ºä»€ä¹ˆä¸èƒ½ç›´æ¥ `await student.update_from_dict(form.model_dump())`ï¼Ÿ

å› ä¸ºï¼š

1. **å­—æ®µåˆ†æ•£åœ¨ä¸¤ä¸ªè¡¨**ï¼š
   - `name`, `age` åœ¨ `Student` è¡¨
   - `address`, `phone` åœ¨ `StudentProfile` è¡¨ï¼ˆä¸€å¯¹ä¸€å…³è”ï¼‰

2. **ä¸èƒ½æŠŠ `address` ç›´æ¥å¡ç»™ `Student` æ¨¡å‹**ï¼ŒTortoise ORM ä¼šæŠ¥é”™ï¼ˆå­—æ®µä¸å­˜åœ¨ï¼‰

æ‰€ä»¥å¿…é¡» **æ‰‹åŠ¨æ‹†åˆ†å­—æ®µ**ï¼Œåˆ†åˆ«æ›´æ–°ä¸¤ä¸ªè¡¨ã€‚

---

## ğŸ§© 4. å®Œæ•´æµç¨‹å›¾è§£ï¼ˆä»¥ PATCH /stu/1 ä¸ºä¾‹ï¼‰

### å®¢æˆ·ç«¯è¯·æ±‚ï¼š
```http
PATCH /stu/1
Content-Type: application/json

{
  "name": "èµµå…­",
  "address": "æ­å·å¸‚"
}
```

### åç«¯å¤„ç†ï¼š

1. FastAPI è‡ªåŠ¨è§£æ body â†’ `form = UpdateStu(name="èµµå…­", address="æ­å·å¸‚")`
2. `form.model_dump(exclude_unset=True)` â†’ `{'name': 'èµµå…­', 'address': 'æ­å·å¸‚'}`
3. åˆ†ç¦»å­—æ®µï¼š
   - `student_update = {'name': 'èµµå…­'}`
   - `profile_update = {'address': 'æ­å·å¸‚'}`
4. åˆ†åˆ«æ‰§è¡Œï¼š
   ```python
   await Student.filter(stuid=1).update(name='èµµå…­')
   await student.profile.update_from_dict({'address': 'æ­å·å¸‚'}).save()
   ```

âœ… å®‰å…¨ã€ç²¾å‡†ã€ä¸ä¼šè¯¯æ¸…ç©ºå­—æ®µï¼

---

## ğŸ§© 5. è¡¥å……ï¼šä¸ºä»€ä¹ˆä¸ç›´æ¥ç”¨ `form.name` åˆ¤æ–­ï¼Ÿ

ä½ å¯èƒ½ä¼šæƒ³ï¼š
```python
if form.name is not None:
    ...
```

ä½†è¿™æœ‰ä¸ªé™·é˜±ï¼š**å¦‚æœç”¨æˆ·çœŸçš„æƒ³æŠŠåå­—è®¾ä¸ºç©ºå­—ç¬¦ä¸² `""` æˆ– 0 å‘¢ï¼Ÿ**

- `exclude_unset=True` èƒ½åŒºåˆ† â€œæ²¡ä¼ â€ vs â€œä¼ äº†ä½†å€¼æ˜¯ç©ºâ€
- è€Œ `is not None` æ— æ³•åŒºåˆ†ï¼ˆå› ä¸ºç©ºå­—ç¬¦ä¸² `""` ä¸æ˜¯ Noneï¼Œä½†å¯èƒ½ä¹Ÿæ˜¯æœ‰æ•ˆå€¼ï¼‰

ä¸è¿‡åœ¨ä½ çš„åœºæ™¯ä¸­ï¼Œ`name` æ˜¯å­—ç¬¦ä¸²ï¼Œé€šå¸¸ä¸ä¼šè®¾ä¸º `None`ï¼Œæ‰€ä»¥ä¸¤ç§æ–¹å¼éƒ½å¯ä»¥ã€‚ä½† **`exclude_unset` æ˜¯æ›´é€šç”¨ã€æ›´å®‰å…¨çš„åšæ³•**ï¼Œå°¤å…¶åœ¨å¤æ‚æ›´æ–°åœºæ™¯ä¸­ã€‚

---

## âœ… æœ€ä½³å®è·µæ€»ç»“

| æ­¥éª¤ | ç›®çš„ |
|------|------|
| `form: UpdateStu` | è‡ªåŠ¨è§£æå¹¶éªŒè¯ JSON è¯·æ±‚ä½“ |
| `form.model_dump(exclude_unset=True)` | åªè·å–ç”¨æˆ·çœŸæ­£æƒ³æ›´æ–°çš„å­—æ®µ |
| æ‰‹åŠ¨æ‹†åˆ†å­—æ®µåˆ°ä¸åŒè¡¨ | å› ä¸º ORM æ¨¡å‹å’Œæ•°æ®åº“è¡¨æ˜¯åˆ†å¼€çš„ |
| åˆ†åˆ«æ›´æ–°ä¸»è¡¨å’Œå…³è”è¡¨ | ä¿è¯æ•°æ®ä¸€è‡´æ€§ |

---

## ğŸ’¡ å°æŠ€å·§ï¼šç®€åŒ–å­—æ®µæå–

ä½ å¯ä»¥ç”¨æ›´ç®€æ´çš„æ–¹å¼æå–å­—æ®µï¼š

```python
update_data = form.model_dump(exclude_unset=True)

# æå– Student å­—æ®µ
student_fields = {k: v for k, v in update_data.items() if k in ('name', 'age')}
if student_fields:
    await Student.filter(stuid=stuid).update(**student_fields)

# æå– Profile å­—æ®µ
profile_fields = {k: v for k, v in update_data.items() if k in ('address', 'phone')}
if profile_fields and student.profile:
    # æ³¨æ„ï¼šphone åœ¨ DB ä¸­å« phonenum
    db_fields = {}
    if 'address' in profile_fields:
        db_fields['address'] = profile_fields['address']
    if 'phone' in profile_fields:
        db_fields['phonenum'] = profile_fields['phone']
    await student.profile.update_from_dict(db_fields).save()
```

---

å¸Œæœ›è¿™æ¬¡è§£é‡Šèƒ½è®©ä½ å½»åº•ç†è§£ï¼å¦‚æœè¿˜æœ‰ä¸æ¸…æ¥šçš„åœ°æ–¹ï¼Œæ¬¢è¿ç»§ç»­è¿½é—® ğŸ˜Š