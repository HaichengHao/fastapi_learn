# 拆分
>这里拆分其实跟之前自己做拆分差不多甚至不够完美
> 但是有几个巧妙的细节处理

- 对于中间件的处理
```python
# @Time    : 2026/1/1 22:26
# @Author  : hero
# @File    : middleware.py

from fastapi.middleware.cors import CORSMiddleware

def  add_cors_middleware(app):
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"]
    )

def request_middleware(app):
    @app.middleware('http')
    async def middleware(request,call_next):
        print('请求前')
        response = await call_next(request)
        print('请求后')
        return response
    return app
```

> 将其封装方便直接在main中调用,巧妙解决了拆分后无app的情况下如何被调用注册app的中间件

- 封装注册数据库的文件
```python
from tortoise.contrib.fastapi import register_tortoise
from fastapi import FastAPI
def register_db(app:FastAPI,config:dict,generate_schemas:bool=True,add_exception_handlers:bool=True):
    register_tortoise(
        app=app,
        config=config,
        generate_schemas=generate_schemas,
        add_exception_handlers=add_exception_handlers
    )
```
> 解决思路差不多，也是改为封装好的函数


- main 函数的一些细节  

```python
# @Time    : 2026/1/1 22:19
# @Author  : hero
# @File    : main.py

import uvicorn
from fastapi import FastAPI
from database import register_db
from app import v1_router
from config  import Tortoise_orm
from  middleware  import add_cors_middleware,request_middleware
app = FastAPI()
add_cors_middleware(app)
request_middleware(app)
app.include_router(v1_router,prefix='/apis/v1',tags=['v1'])
register_db(app,config=Tortoise_orm,generate_schemas=False,add_exception_handlers=True)

if __name__ == '__main__':
    uvicorn.run('main:app',host='127.0.0.1',port=8099,reload=True) 
```