# å…³è”å…³ç³»    

##  ä¸€ã€ä¸€å¯¹å¤šæˆ–å¤šå¯¹ä¸€å…³è”å…³ç³»

1. å®šä¹‰å¤–é”®çº¦æŸ

ä¸€ä¸ªéƒ¨é—¨æœ‰å¤šä¸ªå‘˜å·¥
```python
class Department(Base):
    __tablename__ = 'department'
    id :Mapped[int] = mapped_column(primary_key=True
                                     ,autoincrement=True)

    name:Mapped[str]=mapped_column(String(40),name='dname',unique=True,nullable=False)
    city:Mapped[Optional[str]]=mapped_column(String(40)) #å¯ä»¥ä¸ºç©º

    #important:å®šä¹‰å…³è”å±æ€§,ä¸€ä¸ªéƒ¨é—¨æœ‰å¤šä¸ªå‘˜å·¥,æ‰€ä»¥å¤–é”®è®¾ç½®åœ¨å‘˜å·¥è¡¨ä¸­ï¼Œè¿™è¾¹è®¾ç½®relationship,å’Œä¹‹å‰å­¦flaskçš„æ—¶å€™å¾ˆåƒ
    # åŒå‘å…³ç³»ä¸æ˜¯å¿…é¡»çš„,ä½†æ˜¯åœ¨æŸäº›æƒ…å†µä¸‹ä¼šéå¸¸æ–¹ä¾¿ï¼Œè­¬å¦‚æˆ‘ä»¬å¯ä»¥ç”¨å‘˜å·¥è¡¨æ¥å›è°ƒæŸ¥è¯¢éƒ¨é—¨è¡¨è·å–å‘˜å·¥å¯¹åº”çš„éƒ¨é—¨è¡¨ä¸­çš„è¯¦ç»†ä¿¡æ¯

    #tips:ä¸€ä¸ªéƒ¨é—¨ä¸‹çš„æ‰€æœ‰å‘˜å·¥,ç”±äºå…¶å·²ç»ä¸æ˜¯ä¸€ä¸ªå­—æ®µè€Œæ˜¯ä¸€ä¸ªé›†åˆäº†ï¼Œæ‰€ä»¥ä¸èƒ½ç”¨columnæ¥å¯¹åº”å•ä¸ªå­—æ®µäº†
    # back_populates:å›è°ƒå±æ€§ï¼Œæˆ–è€…è¯´æ˜¯å…³è”å±æ€§,å°±å¾ˆåƒflaskä¸­çš„backref
    # emp_lst:Mapped[list['Employee']]  =  relationship('Employee',back_populates='dep_name')

    #important:â€œæœ¬éƒ¨é—¨ï¼ˆDepartment å®ä¾‹ï¼‰å¯ä»¥é€šè¿‡ emp_lst å±æ€§è®¿é—®å®ƒæ‰€æœ‰çš„å‘˜å·¥ï¼ˆEmployee å¯¹è±¡åˆ—è¡¨ï¼‰ã€‚
    # è€Œæ¯ä¸ªå‘˜å·¥å¯¹è±¡å†…éƒ¨ï¼Œæœ‰ä¸€ä¸ªå« dep_name çš„å±æ€§ï¼Œå¯ä»¥åå‘æŒ‡å›è¿™ä¸ªéƒ¨é—¨ã€‚â€
    emp_lst:Mapped[list['Employee']]  =  relationship(back_populates='dep_name')

```
2. å®šä¹‰åŒå‘å…³ç³»
employeeä¸­è®¾ç½®dep_id,departmentä¸­è®¾ç½®emp_lst
```python
class Department(Base):
    __tablename__ = 'department'
    id :Mapped[int] = mapped_column(primary_key=True
                                     ,autoincrement=True)

    name:Mapped[str]=mapped_column(String(40),name='dname',unique=True,nullable=False)
    city:Mapped[Optional[str]]=mapped_column(String(40)) #å¯ä»¥ä¸ºç©º

    #important:å®šä¹‰å…³è”å±æ€§,ä¸€ä¸ªéƒ¨é—¨æœ‰å¤šä¸ªå‘˜å·¥,æ‰€ä»¥å¤–é”®è®¾ç½®åœ¨å‘˜å·¥è¡¨ä¸­ï¼Œè¿™è¾¹è®¾ç½®relationship,å’Œä¹‹å‰å­¦flaskçš„æ—¶å€™å¾ˆåƒ
    # åŒå‘å…³ç³»ä¸æ˜¯å¿…é¡»çš„,ä½†æ˜¯åœ¨æŸäº›æƒ…å†µä¸‹ä¼šéå¸¸æ–¹ä¾¿ï¼Œè­¬å¦‚æˆ‘ä»¬å¯ä»¥ç”¨å‘˜å·¥è¡¨æ¥å›è°ƒæŸ¥è¯¢éƒ¨é—¨è¡¨è·å–å‘˜å·¥å¯¹åº”çš„éƒ¨é—¨è¡¨ä¸­çš„è¯¦ç»†ä¿¡æ¯

    #tips:ä¸€ä¸ªéƒ¨é—¨ä¸‹çš„æ‰€æœ‰å‘˜å·¥,ç”±äºå…¶å·²ç»ä¸æ˜¯ä¸€ä¸ªå­—æ®µè€Œæ˜¯ä¸€ä¸ªé›†åˆäº†ï¼Œæ‰€ä»¥ä¸èƒ½ç”¨columnæ¥å¯¹åº”å•ä¸ªå­—æ®µäº†
    # back_populates:å›è°ƒå±æ€§ï¼Œæˆ–è€…è¯´æ˜¯å…³è”å±æ€§,å°±å¾ˆåƒflaskä¸­çš„backref
    # emp_lst:Mapped[list['Employee']]  =  relationship('Employee',back_populates='dep_name')

    #important:â€œæœ¬éƒ¨é—¨ï¼ˆDepartment å®ä¾‹ï¼‰å¯ä»¥é€šè¿‡ emp_lst å±æ€§è®¿é—®å®ƒæ‰€æœ‰çš„å‘˜å·¥ï¼ˆEmployee å¯¹è±¡åˆ—è¡¨ï¼‰ã€‚
    # è€Œæ¯ä¸ªå‘˜å·¥å¯¹è±¡å†…éƒ¨ï¼Œæœ‰ä¸€ä¸ªå« dep_name çš„å±æ€§ï¼Œå¯ä»¥åå‘æŒ‡å›è¿™ä¸ªéƒ¨é—¨ã€‚â€
    emp_lst:Mapped[list['Employee']]  =  relationship(back_populates='dep_name')
```

æ¥ç€å°±æ˜¯è¿›è¡Œåˆå§‹åŒ–
```bash
alembic init alembic
```

è¿˜æœ‰ï¼Œå› ä¸ºå®šä¹‰åœ¨ä¸åŒçš„æ–‡ä»¶ä¸­ï¼Œè€Œä¸”ä¸¤å¼ è¡¨éƒ½ç»§æ‰¿äº†__init__ä¸­çš„Base,  
æ‰€ä»¥æƒ³è¦è¿ç§»ç”Ÿæ•ˆçš„è¯éœ€è¦åœ¨__init__ä¸­å¼•å…¥è¿™ä¿©è¡¨
```python
from sqlalchemy.orm import DeclarativeBase
from sqlalchemy import create_engine

#
engine = create_engine(
    url='mysql+pymysql://niko:HHCzio20@localhost:3306/fastapidb4',
    echo=False
)

class Base(DeclarativeBase):
    pass


# âœ… å…³é”®ï¼šæ˜¾å¼å¯¼å…¥æ‰€æœ‰æ¨¡å‹ï¼Œè§¦å‘ç±»æ³¨å†Œåˆ° Base.metadata
from .employee import Employee
from .department import Department

# ï¼ˆå¯é€‰ï¼‰å¯¼å‡ºæ–¹ä¾¿ä½¿ç”¨
__all__ = ["Base", "Employee", "Department"]
```
ç„¶åä¿®æ”¹ç”Ÿæˆçš„alembic.iniçš„æ•°æ®åº“è¿æ¥
å†å»alembic/env.pyä¸­æŒ‡å®šå…ƒæ•°æ®å¯¹è±¡
æ³¨æ„è¿™é‡Œå’Œä¹‹å‰ä¸ä¸€æ ·  
å› ä¸ºæˆ‘ä»¬ä¿©æ¨¡å‹ç±»éƒ½ç»§æ‰¿è‡ªBaseç±»ï¼Œæ‰€ä»¥ä¸ç”¨ä¹‹å‰é‚£æ ·Employee.metadataæˆ–è€…æ˜¯Department.metadata
```python
from ..models import Base
target_metadata = [Base.metadata]

```

## çº§è¿æ“ä½œ,å†™åœ¨relationshipé‡Œå¤´çš„cascadeå‚æ•°
cascade,é»˜è®¤é€‰é¡¹ä¸ºsave-update

- save-update:é»˜è®¤é€‰é¡¹,åœ¨æ·»åŠ ä¸€æ¡æ•°æ®çš„æ—¶å€™,ä¼šæŠŠå…¶å®ƒå’Œæ•°æ®å…³è”çš„æ•°æ®éƒ½æ·»åŠ åˆ°æ•°æ®åº“ä¸­
- delete:è¡¨ç¤ºå½“åˆ é™¤æŸä¸€ä¸ªæ¨¡å‹ä¸­çš„æ•°æ®çš„æ—¶å€™ï¼Œä¹Ÿåˆ é™¤æ‰ä½¿ç”¨relationshipå’Œæ­¤å…³è”çš„æ•°æ®
- delete-orphan:è¡¨ç¤ºå¯¹ä¸€ä¸ªORMå¯¹è±¡è§£é™¤äº†çˆ¶è¡¨ä¸­çš„å…³è”å¯¹è±¡çš„æ—¶å€™ï¼Œè‡ªå·±ä¾¿ä¼šè¢«åˆ é™¤ï¼Œå¦‚æœçˆ¶è¡¨çš„æ•°æ®è¢«åˆ é™¤ï¼Œè‡ªå·±ä¹ŸåŒæ ·ä¼šè¢«åˆ é™¤   
è¿™ä¸ªé€‰é¡¹åªèƒ½ç”¨åœ¨ä¸€å¯¹å¤šä¸Šï¼Œä¸èƒ½ç”¨åœ¨å¤šå¯¹å¤šå’Œå¤šå¯¹ä¸€ä¸Šâš ï¸,å¹¶ä¸”ä½¿ç”¨çš„æ—¶å€™è¿˜éœ€è¦åœ¨å­æ¨¡å‹çš„relationshipä¸­å¢åŠ å‚æ•°`single_parent=True`
- merge:é»˜è®¤é€‰é¡¹,å½“åœ¨ä½¿ç”¨session.mergeåˆå¹¶ä¸€ä¸ªå¯¹è±¡çš„æ—¶å€™ï¼Œä¼šå°†ä½¿ç”¨äº†relationshipç›¸å…³è”çš„å¯¹è±¡ä¹Ÿè¿›è¡Œmergeæ“ä½œ
- expunge:ç§»é™¤æ“ä½œçš„æ—¶å€™,ä¼šå°†ç›¸å…³è”çš„å¯¹è±¡ä¹Ÿè¿›è¡Œç§»é™¤,è¿™ä¸ªæ“ä½œåªæ˜¯ä»sessionä¸­ç§»é™¤,å¹¶ä¸ä¼šçœŸæ­£ä»æ•°æ®åº“ä¸­åˆ é™¤
- all:å¯¹save-updateã€mergeã€refresh-expireã€expungeã€deleteè¿™å‡ ç§çš„ç¼©å†™

## CRUDæ“ä½œ

- **å¢åŠ æ“ä½œ**
```python
 with sessionmaker(engine).begin() as session:
        # tips:å¢åŠ éƒ¨é—¨
        dep1 = Department(
            name='å…­å¿…å±…',
            city='åŒ—äº¬',

        )

        dep2 = Department(
            name='èœœé›ªå†°åŸ',
            city='éƒ‘å·'
        )

        # session.add(dep1)
        session.add(dep2)
        emp1 = Employee(
            name='å¼ ä¸‰',
            salary=2000,
            bonus=300,
            gender=GenderValue.MALE,
            entry_date=date(2026, 1, 7),
        )
        emp2 = Employee(
            name='æå››',
            salary=5000,
            bonus=300,
            gender=GenderValue.FEMALE,
            entry_date=date(2026, 1, 8),
        )

        emp3 = Employee(
            name='ç‹äº”',
            salary=4000,
            bonus=3000,
            gender=GenderValue.FEMALE,
            entry_date=date(2026, 1, 9),
        )
        # tips:ç»™å‘˜å·¥æŒ‡å®šéƒ¨é—¨,æŒ‰ç…§æˆ‘ä»¬åˆšæ‰æçš„æŒ‡å®šå…³è”å…³ç³»æ¥æŒ‡å®š
        # emp1.dep_name=dep1
        # emp2.dep_name=dep1
        # tips:ä¹Ÿå¯ä»¥ç«™åœ¨éƒ¨é—¨è¡¨çš„è§†è§’
        # dep1.emp_lst = [emp1, emp2]
        dep2.emp_lst = [emp3]

        # session.add(dep1) #important:ç”±äºå»ºç«‹äº†å…³è”å…³ç³»,å¦‚æœæˆ‘ä»¬æ‰§è¡Œæ·»åŠ çš„è¯,éƒ¨é—¨è¡¨å’Œå‘˜å·¥è¡¨å°±éƒ½æœ‰äº†
        session.add(dep2)
```
- ä¿®æ”¹æ“ä½œ

```python
# important:ä¿®æ”¹æ“ä½œ,å…ˆæŸ¥åæ”¹
emp2 = session.get(Employee, 2)
dept = session.get(Department, 2)
emp2.dep_name = dept  # tips:é€šè¿‡å…³è”å±æ€§æ¥å…³è”
emp2.dep_id = dept.id  # tips:é€šè¿‡å¤–é”®æ¥å…³è”
# tips:ä¹Ÿå¯ä»¥ç«™åœ¨éƒ¨é—¨è§†è§’
# dept.emp_lst = [emp2]

ustmt = Update(Employee).where(Employee.name == 'å¼ ä¸‰').values(salary=2123)
session.execute(ustmt)

```
- æŸ¥è¯¢æ“ä½œ

```python
# tips:é€šè¿‡éƒ¨é—¨è¡¨æŸ¥è¯¢å‘˜å·¥
dept = session.get(Department, 1)
employeeslst = dept.emp_lst
for emp in employeeslst:
    print(emp)
# tips:é€šè¿‡å‘˜å·¥è¡¨æ¥æŸ¥è¯¢éƒ¨é—¨,é€šè¿‡å…³è”å…³ç³»æ¥æŸ¥æ‰¾,å› ä¸ºå…³è”çš„dep_nameçš„ç±»å‹æ˜¯Departmentå¤§ç±»,æ‰€ä»¥è¦æƒ³æ‹¿åˆ°å¤§ç±»é‡Œçš„å±æ€§å°±å¾—é€šè¿‡å¤§è±¡ç±»å‹,æ‹¿åˆ°å®ƒçš„.name
emp2 = session.get(Employee, 2)
print(emp2.dep_name.name)
```

- åˆ é™¤æ“ä½œ(ç”Ÿäº§ä¸­éƒ½æ˜¯é€»è¾‘åˆ é™¤)

```python
# important:åˆ é™¤æ“ä½œ
# tips:è®¾ç½®å¼ ä¸‰çš„éƒ¨é—¨ä¸ºç©º
session.execute(Update(Employee).where(Employee.name == 'å¼ ä¸‰').values(dep_id=None))
# tips:æˆ–è€…å…ˆæŸ¥ååˆ é™¤
emplisi = session.get(Employee, 2)
emplisi.dep_id = None 
```
--- 

## æ ‘å½¢ç»“æ„çš„è‡ªå…³è”
åœ¨departmentè¡¨ä¸­

```python
# tips:å®ç°è‡ªå…³è”
# tips:å®šä¹‰ä¸€ä¸ªå¤–é”®pid,å…³è”åˆ°çˆ¶æœºæ„id
pid: Mapped[Optional[int]] = mapped_column(ForeignKey('department.id'),
                                           nullable=True)  # è‡ªå·±å…³è”è‡ªå·±,æ‰€ä»¥å¤–é”®å°±æ˜¯è‡ªå·±çš„ä¸»é”®,å…è®¸ä¸ºç©ºï¼Œå› ä¸ºé¡¶çº§æœºæ„æ²¡æœ‰çˆ¶æœºæ„

children: Mapped[list['Department']] = relationship(back_populates='parentname')
# å½“å‰æœºæ„çš„çˆ¶æœºæ„
parentname: Mapped[Optional['Department']] = relationship(back_populates='children',
                                                          remote_side=[id])  # important:è‡ªå…³è”çš„æ—¶å€™ä¸€å®šè¦åŠ ä¸Š
```
- ä¸ºä»€ä¹ˆéœ€è¦remot_eside
>å› ä¸ºåœ¨ä¸€ä¸ªè¡¨è‡ªå·±å…³è”è‡ªå·±çš„æ—¶å€™ï¼ŒSQLAlchemy æ— æ³•è‡ªåŠ¨åˆ¤æ–­å“ªä¸€ç«¯æ˜¯â€œçˆ¶â€ã€å“ªä¸€ç«¯æ˜¯â€œå­â€ï¼Œæ‰€ä»¥ä½ éœ€è¦ç”¨ remote_side=[id] 
> æ˜ç¡®å‘Šè¯‰å®ƒï¼šâ€œè¿™ä¸€ä¾§ï¼ˆparentnameï¼‰æŒ‡å‘çš„æ˜¯å¦ä¸€è¡Œçš„ä¸»é”®ï¼ˆå³è¿œç¨‹çš„ idï¼‰â€ã€‚

Departmentè¡¨ç»“æ„å¦‚ä¸‹(ç®€åŒ–)  

| id | name     | pid  |
|----|----------|------|
| 1  | æ€»å…¬å¸   | NULL |
| 2  | ç ”å‘éƒ¨   | 1    |
| 3  | å‰ç«¯ç»„   | 2    |

- pid æ˜¯å¤–é”®ï¼ŒæŒ‡å‘ department.id
- æ‰€ä»¥
  - ç ”å‘éƒ¨.parentname â†’ æ€»å…¬å¸
  - æ€»å…¬å¸.children â†’ [ç ”å‘éƒ¨, ...]
è¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„ æ ‘å½¢ç»“æ„ï¼ˆçˆ¶å­å…³ç³»ï¼‰ã€‚

â“ é—®é¢˜æ¥äº†ï¼šSQLAlchemy å¦‚ä½•çŸ¥é“è°æ˜¯â€œçˆ¶â€è°æ˜¯â€œå­â€ï¼Ÿ
å½“å†™  
```python
children = relationship("Department", back_populates="parentname")
parentname = relationship("Department", back_populates="children")
```
SQLAlchemy çœ‹åˆ°ä¸¤ä¸ªå­—æ®µéƒ½æŒ‡å‘åŒä¸€ä¸ªè¡¨ Departmentï¼Œå¹¶ä¸”é€šè¿‡å¤–é”® pid å…³è”ã€‚
ä½†å®ƒä¸çŸ¥é“ï¼š  
children æ˜¯â€œæˆ‘æœ‰å“ªäº›å­éƒ¨é—¨â€ï¼ˆå³ï¼šæ‰¾ pid = æˆ‘çš„ id çš„é‚£äº›è¡Œï¼‰  
è¿˜æ˜¯â€œæˆ‘æ˜¯è°çš„å­éƒ¨é—¨â€ï¼ˆå³ï¼šæ‰¾ id = æˆ‘çš„ pid çš„é‚£ä¸ªè¡Œï¼‰
å®ƒåˆ†ä¸æ¸…æ–¹å‘ï¼  
è¿™å°±å¯¼è‡´æ­§ä¹‰ â€”â€” è€Œ SQLAlchemy åœ¨è‡ªå…³è”æ—¶å¿…é¡»æ˜ç¡®æ–¹å‘   

**âœ… remote_side çš„ä½œç”¨ï¼šæŒ‡å®šâ€œè¿œç¨‹ç«¯â€**  
- åœ¨å…³ç³»ä¸­ï¼Œæ€»æœ‰ä¸€ç«¯æ˜¯ æœ¬åœ°ï¼ˆlocalï¼‰ï¼Œä¸€ç«¯æ˜¯ è¿œç¨‹ï¼ˆremoteï¼‰
- å¯¹äº parentnameï¼ˆå½“å‰éƒ¨é—¨çš„çˆ¶éƒ¨é—¨ï¼‰ï¼š
  - æœ¬åœ°åˆ—ï¼špidï¼ˆå½“å‰è¡Œçš„å¤–é”®ï¼‰
  - è¿œç¨‹åˆ—ï¼šidï¼ˆè¢«å¼•ç”¨çš„é‚£è¡Œçš„ä¸»é”®ï¼‰  


æ‰€ä»¥ä½ è¦å‘Šè¯‰ SQLAlchemyï¼š  
â€œå½“æˆ‘è®¿é—® dept.parentname æ—¶ï¼Œè¯·ç”¨æˆ‘çš„ pid å»åŒ¹é… å…¶ä»–è¡Œçš„ idã€‚â€ 
è¿™å°±æ˜¯ remote_side=[id] çš„å«ä¹‰ï¼š  

```python
parentname: Mapped[Optional['Department']] = relationship(
    back_populates='children',
    remote_side=[id]  # â† æŒ‡æ˜ï¼šè¿œç¨‹ç«¯æ˜¯ id åˆ—ï¼ˆå³çˆ¶éƒ¨é—¨çš„ä¸»é”®ï¼‰
)
```  
è€Œ children ä¸éœ€è¦ remote_sideï¼Œå› ä¸ºï¼š  
- å®ƒæ˜¯åå‘å…³ç³»ï¼ˆç”± back_populates è‡ªåŠ¨æ¨å¯¼ï¼‰
- SQLAlchemy èƒ½ä» parentname çš„å®šä¹‰ä¸­åæ¨å‡º children çš„æ–¹å‘  

**ğŸ§© ç±»æ¯”ç†è§£ï¼ˆåƒæŒ‡é’ˆï¼‰**  
æƒ³è±¡æ¯è¡Œæ•°æ®æœ‰ä¸¤ä¸ªâ€œæŒ‡é’ˆâ€ï¼š   
pid æŒ‡å‘ çˆ¶èŠ‚ç‚¹çš„ idï¼ˆå‡ºè¾¹ï¼‰  
children æ˜¯ æ‰€æœ‰ä»¥æˆ‘ä¸ºçˆ¶çš„èŠ‚ç‚¹ï¼ˆå…¥è¾¹ï¼‰  
remote_side=[id] å°±æ˜¯åœ¨è¯´ï¼š  
â€œè¿™ä¸ª relationship æ˜¯é€šè¿‡ å¯¹æ–¹çš„ id æ¥è¿æ¥çš„â€ã€‚    


**ğŸš« å¦‚æœä¸åŠ  remote_side ä¼šæ€æ ·ï¼Ÿ**
ä½ ä¼šé‡åˆ°ç±»ä¼¼è¿™æ ·çš„é”™è¯¯ï¼š      
```text
sqlalchemy.exc.AmbiguousForeignKeysError: 
Could not determine join condition between parent/child tables on relationship ...  

```

æˆ–è€…æ›´éšè”½çš„é—®é¢˜ï¼šå…³ç³»æ–¹å‘åäº†ï¼Œæ¯”å¦‚ children è¿”å›çš„æ˜¯çˆ¶éƒ¨é—¨ï¼Œè€Œä¸æ˜¯å­éƒ¨é—¨ï¼  


ä¹‹åæ›´æ–°è¿ç§»    
![img_1.png](img_1.png)    
å¯ä»¥çœ‹åˆ°pidå…³è”åˆ°äº†è‡ªå·±æœ¬èº«çš„id  


- æ’å…¥æ•°æ®æµ‹è¯•

```python
if __name__ == '__main__':
    with sessionmaker(engine).begin() as session:
        # dep1 = Department(name='æ·±åœ³æ€»å…¬å¸', city='æ·±åœ³')  #tips:åˆ›ç«‹æ€»å…¬å¸è®°å½•
        # session.add(dep1)

        dep0 = Department(name='è¡Œæ”¿éƒ¨', city='æ·±åœ³', pid=1)
        dep2 = Department(name='éƒ‘å·äºŒä¸ƒåŒºåˆ†å…¬å¸', city='éƒ‘å·', pid=1)  # tips:æŒ‡å®špid,è¡¨æ˜å…¶æ¯å…¬å¸idä¸º1,å®ç°departmentè¡¨çš„è‡ªå…³è”
        dep3 = Department(name='é”€å”®éƒ¨', parentname=dep2, city='éƒ‘å·')  # tips:æŒ‡å®šå…¶ä¸ºéƒ‘å·åˆ†å…¬å¸çš„éƒ¨é—¨

        session.add(dep0)
        session.add(dep2)  # tips:è¿™æ ·åªéœ€è¦å•ç‹¬æ·»åŠ dep2,åˆ™ä¸å…¶æœ‰å…³è”å…³ç³»praentnameçš„å­èŠ‚ç‚¹dep3ä¹Ÿä¼šè¢«åˆ›å»º
```

---  
## äºŒ ã€ä¸€å¯¹ä¸€å…³è”å…³ç³»
ä¸€å¯¹ä¸€å…³ç³»å®é™…ä¸Šæ˜¯é€šè¿‡å»ºç«‹åŒå‘å…³ç³»çš„ä¸€å¯¹å¤šå…³ç³»çš„åŸºç¡€ä¸Šè½¬åŒ–è€Œæ¥  
æ¯”å¦‚:ä¸€ä¸ªç”¨æˆ·å¯¹åº”ä¸€å¼ èº«ä»½è¯,ä¸€å¼ èº«ä»½è¯å±äºä¸€ä¸ªç”¨æˆ·

å®šä¹‰èº«ä»½è¯è¡¨   
- éœ€è¦æ³¨æ„çš„æ˜¯,è¿™æ¬¡æ˜¯å°†èº«ä»½è¯ä½œä¸ºä»è¡¨,æ‰€ä»¥å¤–é”®å†™åœ¨è¿™é‡Œ,å…³è”çš„æ˜¯å‘˜å·¥è¡¨çš„ä¸»é”®id
- è¿˜æœ‰å»ºç«‹å…³è”å…³ç³»çš„æ—¶å€™ä¸€å®šè¦è®¾ç½®single_parentä¸ºTrue,æ„æ€æ˜¯å…¶åªæœ‰ä¸€ä¸ªæ¯è¡¨,åŒæ—¶å‘˜å·¥è¡¨ä¹Ÿè¦æ·»åŠ å…³è”å…³ç³»

èº«ä»½è¯è¡¨:  
```python
class  IDCard(Base):
    __tablename__ = 'id_card'
    id:Mapped[int] = mapped_column(primary_key=True,autoincrement=True)
    card_number:Mapped[str]=mapped_column(String(18),unique=True,nullable=False,comment='èº«ä»½è¯å·ç ')
    
    native_place:Mapped[Optional[str]]=mapped_column(String(40),nullable=True,comment='ç±è´¯ä¿¡æ¯')
    
    #tips:æ·»åŠ å¤–é”®çº¦æŸ,ç”±äºæ˜¯ä¸€å¯¹ä¸€å…³è”å…³ç³»,æ‰€ä»¥åœ¨empè¡¨æˆ–è€…idcè¡¨æ·»åŠ éƒ½å¯ä»¥
    emp_id :Mapped[int] = mapped_column(ForeignKey('employee.id'))
    #tips:è®¾ç½®å…³è”å±æ€§,è®¾ç½®single_parentè¡¨ç¤ºä¸€ä¸ªä»è¡¨åªèƒ½å…³è”ä¸€ä¸ªä¸»è¡¨çš„è®°å½•,è­¬å¦‚ä¸€ä¸ªèº«ä»½è¯åªèƒ½å¯¹åº”ä¸€åå‘˜å·¥,ä¸èƒ½ä¸€ä¸ªèº«ä»½è¯å¯¹åº”å¤šä¸ªå‘˜å·¥
    emp:Mapped[Optional['Employee']] = relationship(single_parent=True,back_populates='idc')
```

å‘˜å·¥è¡¨æ·»åŠ å…³è”å…³ç³»  
```python
class Employee(Base, TimestampMixin):
    __tablename__ = 'employee'
    ......
    #tips:æ·»åŠ å…³è”å…³ç³»,ä¸»è¡¨ä¸ç”¨å†™single_paret
    idc:Mapped[Optional['IDCard']]=relationship( back_populates='emp')
    
    def __str__(self):
        return f'{self.name},{self.salary},{self.bonus},{self.gender}'
```
è®°å¾—ä¿®æ”¹ä¹‹åè®°å¾—ä¸€å®šè¦åœ¨__init__ä¸­å¯¼å…¥,ä¸ç„¶è¡¨ä¸ä¼šåˆ›å»ºcommitå’Œupgrade
```python
from sqlalchemy.orm import DeclarativeBase,sessionmaker
from sqlalchemy import create_engine
from sqlalchemy import *
from datetime import date

#
engine = create_engine(
    url='mysql+pymysql://niko:HHCzio20@localhost:3306/fastapidb4',
    echo=False
)

class Base(DeclarativeBase):
    pass
#
#
# âœ… å…³é”®ï¼šæ˜¾å¼å¯¼å…¥æ‰€æœ‰æ¨¡å‹ï¼Œè§¦å‘ç±»æ³¨å†Œåˆ° Base.metadata
from .employee import Employee,GenderValue,IDCard
from .department import Department

# ï¼ˆå¯é€‰ï¼‰å¯¼å‡ºæ–¹ä¾¿ä½¿ç”¨
__all__ = ["Base", "Employee", "Department"]
```

![img_2.png](img_2.png)   
![img_3.png](img_3.png)  

æ•°æ®æ’å…¥æµ‹è¯•    
```python
if __name__ == '__main__':
  with sessionmaker(engine).begin() as session:
      #tips:ç»™idä¸º1çš„å‘˜å·¥ç»‘å®šèº«ä»½è¯å·ç 
      idc = IDCard(card_number='103387200011110666',native_place='åŒ—äº¬',emp_id=1)
      session.add(idc)
```
æŸ¥è¯¢æµ‹è¯•,æ ¹æ®å‘˜å·¥è¡¨æŸ¥è¯¢å‘˜å·¥å¯¹åº”çš„èº«ä»½è¯å·ç   
```python
  #tips:é€šè¿‡å‘˜å·¥è¡¨æŸ¥è¯¢å…¶èº«ä»½è¯å·ç 
        EMP1= session.get(Employee,1)
        print(EMP1.idc.card_number)
```

## å¤šå¯¹å¤šå…³è”å…³ç³»   

å®šä¹‰å’Œæ’å…¥æ•°æ®
```python
# @Time    : 2026/1/14 16:30
# @Author  : hero
# @File    : model.py
from typing import Optional

from sqlalchemy.orm import sessionmaker, DeclarativeBase, Mapped, mapped_column, relationship
from sqlalchemy import *

engine = create_engine('mysql+pymysql://niko:HHCzio20@localhost:3306/fastapidb5')


class Base(DeclarativeBase):
    __abstract__ = True


# important:å®šä¹‰ä¸­é—´è¡¨,å®ƒæ˜¯ä¸€ä¸ªçº¯ç²¹çš„è¡¨
midtable = Table(
    'userandrole',
    Base.metadata,
    Column('user_id', Integer, ForeignKey('user.id'), primary_key=True),
    Column('role_id', Integer, ForeignKey('role.id'), primary_key=True),
)


class User(Base):
    __tablename__ = 'user'
    id: Mapped[int] = mapped_column(Integer, primary_key=True)
    username: Mapped[str] = mapped_column(String(20), unique=True, nullable=False, comment='ç”¨æˆ·å')
    password: Mapped[str] = mapped_column(String(20), nullable=False, comment='å¯†ç ')
    # tips:æ„å»ºå¤šå¯¹å¤šçš„å…³è”å…³ç³»
    roles: Mapped[Optional[list['Role']]] = relationship(secondary=midtable,
                                                         back_populates='users')  # tips:å­¦ä¸‹æ¥å‘ç°,sqlalchemyç”¨åœ¨fastapiä¸­å’Œflaskçš„å†™æ³•æ˜¯å·®ä¸å¤šçš„,å°¤å…¶æ˜¯æ¶‰åŠåˆ°å¤šè¡¨å…³ç³»


class Role(Base):
    __tablename__ = 'role'
    id: Mapped[int] = mapped_column(Integer, primary_key=True)
    name: Mapped[str] = mapped_column(String(20), nullable=False, comment='è§’è‰²å')
    users: Mapped[Optional[list['User']]] = relationship(secondary=midtable, back_populates='roles')


if __name__ == '__main__':
    with sessionmaker(bind=engine).begin() as session:
        # important:å¤šå¯¹å¤šçš„æ•°æ®æ“ä½œ
        u1 = User(username='zhangsan',password='zhangsan123')
        u2 = User(username='lisi',password='lisi123')
        
        r1 = Role(name='ä»“åº“ç®¡ç†å‘˜')
        r2 = Role(name='ç³»ç»Ÿç®¡ç†å‘˜')
        
        #tips:ç»™u1æŒ‡å®šä¸¤ä¸ªè§’è‰²
        u1.roles.append([r1,r2])  
        u2.roles=[r2]
        session.add(u1)
        #important:è¿™æ ·æ·»åŠ ä¸€ä¸ªå°±ä¼šæ‰¾åˆ°u1å…³è”äº†r1å’Œr2,ç„¶åæ·»åŠ r2çš„æ—¶å€™å‘ç°r2å’Œu2æœ‰å…³è”å…³ç³»,ä¹Ÿä¼šè‡ªåŠ¨æ·»åŠ 
        
     
        
     
```