# alebmicæ•°æ®åº“è¿ç§»å·¥å…·
ä¹‹å‰æˆ‘ä»¬æ¯æ¬¡æ‰‹åŠ¨ä¿®æ”¹ä¹‹åè¿˜éœ€è¦å†æ¬¡è¿è¡Œç”Ÿæˆï¼Œå¾ˆä¸æ–¹ä¾¿

```python
if __name__ == '__main__':
    Base.metadata.create_all(engine)#tips:åˆ©ç”¨è¿™ä¸ªæ¥åˆ›å»ºè¡¨
```
ğŸ‘†è¿™ç§ä¹‹åæˆ‘ä»¬å¾ˆå°‘ç”¨

---
Alembic ä½¿ç”¨SQLAlchemyä½œä¸ºåº•å±‚å¼•æ“ï¼Œä¸ºå…³ç³»æ•°æ®åº“æä¾›å˜æ›´ç®¡ç†è„šæœ¬çš„åˆ›å»ºã€ç®¡ç†å’Œè°ƒç”¨
1. å®‰è£…
```bash
pip install alembic
```
2. åˆå§‹åŒ–alembicç¯å¢ƒ
```bash
alembic init alembic
```
```bash
(.venvs) nikofox@MOSS:~/fastapi_learn/15ORM_sqlalchemy_alembic/03alembicè¿ç§»å·¥å…·$ alembic init alebmic
  Creating directory /home/nikofox/fastapi_learn/15ORM_sqlalchemy_alembic/03alembicè¿ç§»å·¥å…·/alebmic ...  done
  Creating directory /home/nikofox/fastapi_learn/15ORM_sqlalchemy_alembic/03alembicè¿ç§»å·¥å…·/alebmic/versions ...  done
  Generating /home/nikofox/fastapi_learn/15ORM_sqlalchemy_alembic/03alembicè¿ç§»å·¥å…·/alembic.ini ...  done
  Generating /home/nikofox/fastapi_learn/15ORM_sqlalchemy_alembic/03alembicè¿ç§»å·¥å…·/alebmic/script.py.mako ...  done
  Generating /home/nikofox/fastapi_learn/15ORM_sqlalchemy_alembic/03alembicè¿ç§»å·¥å…·/alebmic/env.py ...  done
  Generating /home/nikofox/fastapi_learn/15ORM_sqlalchemy_alembic/03alembicè¿ç§»å·¥å…·/alebmic/README ...  done
  Please edit configuration/connection/logging settings in /home/nikofox/fastapi_learn/15ORM_sqlalchemy_alembic/03alembicè¿ç§»å·¥å…·/alembic.ini before proceeding.
  ```

ç„¶åå°±ç”Ÿæˆäº†ä¸¤ä¸ªæ–‡ä»¶
![img.png](img.png)

## åšä¿®æ”¹å®šåˆ¶
1. éœ€è¦ä¿®æ”¹alembic.iniä¸­çš„æ•°æ®åº“è¿æ¥
![img_1.png](img_1.png)

2. ä¿®æ”¹alebmicæ–‡ä»¶å¤¹ä¸‹çš„env.pyæ–‡ä»¶ï¼Œå¯¼å…¥æˆ‘ä»¬åˆ›å»ºçš„æ¨¡å‹ç±»å¹¶ä¿®æ”¹target_metadata
![img_2.png](img_2.png)

3. è¾“å…¥è‡ªåŠ¨ç”Ÿæˆè¿ç§»è„šæœ¬çš„å‘½ä»¤
```bash
#è‡ªåŠ¨ç”Ÿæˆè¿ç§»è„šæœ¬
alembic revision --autogenerate -m "init commit" #æ³¨æ„ä¿®æ”¹äº†ormä¹‹åï¼Œä¿®æ”¹-måè¿ç§»è„šæœ¬æç¤º,ä¿¡æ¯è‡ªå·±éšä¾¿å¡«
#æ•°æ®åº“è¿ç§»å‘½ä»¤
alembic upgrade head

```
- `alebmic upgrade head` :å°†æ•°æ®åº“å‡çº§åˆ°æœ€æ–°ç‰ˆæœ¬
- `alebmic downgrade   base` :å°†æ•°æ®åº“é™çº§åˆ°æœ€åˆç‰ˆæœ¬
- `alebmic upgrade <version>`  :å°†æ•°æ®åº“å‡çº§åˆ°æŒ‡å®šç‰ˆæœ¬
- `alebmic downgrade <version>`:å°†æ•°æ®åº“é™çº§åˆ°æŒ‡å®šç‰ˆæœ¬
--- 
ç”Ÿæˆç»“æœ
```bash
(.venvs) nikofox@MOSS:~/fastapi_learn/15ORM_sqlalchemy_alembic/03alembicè¿ç§»å·¥å…·$ alembic revision --autogenerate -m "first generate table"
INFO  [alembic.runtime.migration] Context impl MySQLImpl.
INFO  [alembic.runtime.migration] Will assume non-transactional DDL.
INFO  [alembic.autogenerate.compare] Detected added column 'employee.salary'
INFO  [alembic.autogenerate.compare] Detected added column 'employee.bonus'
INFO  [alembic.autogenerate.compare] Detected added column 'employee.is_leave'
INFO  [alembic.autogenerate.compare] Detected added column 'employee.gender'
  Generating /home/nikofox/fastapi_learn/15ORM_sqlalchemy_alembic/03alembicè¿ç§»å·¥å…·/alebmic/versions/431154b2577b_first_generate_table.py ...  done
(.venvs) nikofox@MOSS:~/fastapi_learn/15ORM_sqlalchemy_alembic/03alembicè¿ç§»å·¥å…·$ alembic upgrade   head
INFO  [alembic.runtime.migration] Context impl MySQLImpl.
INFO  [alembic.runtime.migration] Will assume non-transactional DDL.
INFO  [alembic.runtime.migration] Running upgrade  -> 431154b2577b, first generate table
```

ç„¶åå¯ä»¥çœ‹åˆ°æ–‡ä»¶ä¸­çš„versionsç”Ÿæˆäº†æ–°çš„è®°å½•ï¼Œæ•°æ®åº“ä¸­çš„æ•°æ®è¡¨ä¹Ÿç”Ÿæˆäº†
![img_3.png](img_3.png)
```bash
Database changed
mysql> show tables;
+----------------------+
| Tables_in_fastapidb4 |
+----------------------+
| alembic_version      |
| employee             |
+----------------------+
2 rows in set (0.00 sec)

mysql> desc  alembic;
ERROR 1146 (42S02): Table 'fastapidb4.alembic' doesn't exist
mysql> desc  alembic_version;
+-------------+-------------+------+-----+---------+-------+
| Field       | Type        | Null | Key | Default | Extra |
+-------------+-------------+------+-----+---------+-------+
| version_num | varchar(32) | NO   | PRI | NULL    |       |
+-------------+-------------+------+-----+---------+-------+
1 row in set (0.00 sec)

mysql> select * from alembic_version;
+--------------+
| version_num  |
+--------------+
| 431154b2577b |
+--------------+
1 row in set (0.00 sec)

mysql> desc employee;
+-------------+-----------------------+------+-----+---------+----------------+
| Field       | Type                  | Null | Key | Default | Extra          |
+-------------+-----------------------+------+-----+---------+----------------+
| id          | int                   | NO   | PRI | NULL    | auto_increment |
| name        | varchar(40)           | NO   | UNI | NULL    |                |
| create_time | datetime              | NO   |     | NULL    |                |
| update_time | datetime              | NO   |     | NULL    |                |
| salary      | decimal(10,2)         | NO   |     | NULL    |                |
| bonus       | int                   | NO   |     | NULL    |                |
| is_leave    | tinyint(1)            | NO   |     | NULL    |                |
| gender      | enum('MALE','FEMALE') | NO   |     | NULL    |                |
+-------------+-----------------------+------+-----+---------+----------------+
8 rows in set (0.00 sec)
```

## ç‰ˆæœ¬æ›´æ–°å’Œè¿ç§»
åœ¨æ•°æ®è¿›è¡Œä¿®æ”¹ä¹‹åéœ€è¦é‡æ–°ç”Ÿæˆå¹¶æ›´æ–°
```bash
(.venvs) nikofox@MOSS:~/fastapi_learn/15ORM_sqlalchemy_alembic/03alembicè¿ç§»å·¥å…·$ alembic revision  --autogenerate -m "addnewcolumnentrydate"
INFO  [alembic.runtime.migration] Context impl MySQLImpl.
INFO  [alembic.runtime.migration] Will assume non-transactional DDL.
INFO  [alembic.autogenerate.compare] Detected added column 'employee.entry_date'
  Generating /home/nikofox/fastapi_learn/15ORM_sqlalchemy_alembic/03alembicè¿ç§»å·¥å…·/alebmic/versions/b7ac89dd0a3f_addnewcolumnentrydate.py ...  done
(.venvs) nikofox@MOSS:~/fastapi_learn/15ORM_sqlalchemy_alembic/03alembicè¿ç§»å·¥å…·$ alembic upgrade head
INFO  [alembic.runtime.migration] Context impl MySQLImpl.
INFO  [alembic.runtime.migration] Will assume non-transactional DDL.
INFO  [alembic.runtime.migration] Running upgrade 431154b2577b -> b7ac89dd0a3f, addnewcolumnentrydate
```

å¯ä»¥çœ‹åˆ°è¿›è¡Œäº†æ›´æ–°
![img_4.png](img_4.png)