# asynccontextmanager  

## 声明周期事件   

> 在用Fastapi使用ORM创建数据库的时候,我们希望它是异步的  
> 并且我们希望程序在启动的时候先初始化数据库，而不是首次启动就需要我们自己用alembic迁移   
> 
 
- 这里要强调一件事,那就是Fastapi中初始化引擎我们要用异步的 
- 而在做迁移的时候,我们用的是同步的,接下来我会详细解释这一点❗❗❗❗❗❗   
0. 构建env文件并设置config.py  
.env文件
```text
DATABASE_URL='postgresql+asyncpg://postgres:HHCzio20.@localhost:5432/fsdb'
```
注意,这个DATABASE_URL的driver用的是asyncpg,它是给异步上下文管理器用的,运行程序的时候会初始化表 
而之后利用alembic的时候将会使用同步的driver`psycopg2`sqlalchemy.url =postgresql+psycopg2://postgres:HHCzio20.@localhost:5432/fsdb

config.py文件
```python
"""
@File    :config.py
@Editor  : 百年
@Date    :2026/2/9 17:49 
"""
import os

from pydantic_settings import BaseSettings,SettingsConfigDict

class Settings(BaseSettings):
    DATABASE_URL : str
    model_config = SettingsConfigDict(
        env_file=".env",
        extra="ignore"
    )

Config = Settings()
print(Config.DATABASE_URL)
```

1. 创建model
src.models.\_\_init\_\_.py  
创建这个是方便如果有多表利用sqlalchemy建表都要调用这个,优化代码，减少冗余
```python 
from sqlalchemy.orm import DeclarativeBase
class Base(DeclarativeBase):
    pass

```
src.models.employee.py  
```python
"""
@File    :employee.py
@Editor  : 百年
@Date    :2026/2/9 18:57 
"""
from sqlalchemy import DateTime, func,String,DECIMAL,Boolean,Enum as SAEnum,\
    or_,ForeignKey
import enum
from . import Base

from typing import Optional
from datetime import datetime,date
from sqlalchemy.orm import mapped_column,Mapped,relationship
from decimal import Decimal
class TimestampMixin:
    created_time:Mapped[datetime]=mapped_column(
        DateTime,
        insert_default=func.now(),
        comment='创建时间'

    )
    update_time:Mapped[datetime]=mapped_column(
        DateTime,
        insert_default=func.now(),
        onupdate=func.now(),
        comment='记录修改时间'
    )
class GenderValue(enum.Enum):
    MALE = '男'
    FEMAL='女'
class Employee(Base,TimestampMixin):
    __tablename__ = 'employee'
    id:Mapped[int]=mapped_column(primary_key=True,autoincrement=True)
    name:Mapped[str]=mapped_column(String(40),unique=True,nullable=False)
    salary:Mapped[Decimal]=mapped_column(DECIMAL(10,2),nullable=False)
    bonus:Mapped[int]=mapped_column(default=0,comment='员工资金')
    is_leave:Mapped[int]=mapped_column(Boolean,default=False,comment='是否离职，默认为非')
    gender:Mapped[GenderValue]=mapped_column(SAEnum(GenderValue),nullable=False)
    entry_date:Mapped[date]=mapped_column(DateTime,insert_default=func.now(),nullable=False,comment='入职时间')


```

2. 创建异步引擎生成器  
根目录下创建cr_asyncengine.py
构造异步引擎生成器可以方便我们进行异步引擎生成和异步session的生成 
并且显式导入orm
```python
"""
@File    :cr_asyncengine.py
@Editor  : 百年
@Date    :2026/2/9 19:27 
"""


from sqlalchemy.ext.asyncio.session import AsyncSession
from sqlalchemy.ext.asyncio import create_async_engine,async_sessionmaker
from config import Config
from src.models.employee import Employee  #important:显式导入
from src.models import Base
__all__=['Employee']
#tips:创建异步引擎
engine = create_async_engine(
    url=Config.DATABASE_URL,
    echo=True
)

#important:创建一个异步函数用于声明周期事件

async def init_db():
    async with engine.begin() as conn:
        await conn.run_sync(Base.metadata.create_all)

async def get_session() -> AsyncSession:
    AsyncSessionlocal = async_sessionmaker(
        bind=engine,
        expire_on_commit=False,
        class_=AsyncSession
    )
    async with AsyncSessionlocal() as session:
        yield session


```
> 上面有一个不得不提的点,回忆一下  

| sqlalchemy                                                                                                                                                       | sqlmodel                                                                                          |
|------------------------------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------|
| 创建orm对象关系模型的时候用的是`from sqlalchemy.orm import DeclarativeBase`,然后构造Base继承与DeclarativeBase,  <br/>而后创建的Employee继承与这个Base,所以conn.run_sync(Base.metadata.create_all) | sqlmodel中则是直接继承SQLModel,这样它在构造上下文管理器并用异步引擎创建表的时候就是使用`conn.run_sync(SQLModel.metadata.create_all)` |

3. 构建初始化app的文件，并在此处理上下文管理  

声明周期事件管理首次运行时的数据库初始化
src\\_\_init\_\_.py 
```python
"""
@File    :__init__.py.py
@Editor  : 百年
@Date    :2026/2/9 19:40 
"""
from fastapi import FastAPI
from contextlib import asynccontextmanager
from cr_asyncengine import init_db

@asynccontextmanager
async def life_span(app: FastAPI):
    print('服务器正在启动')
    await init_db()
    yield
    print('服务器已经停止')

version='v1.0.0'
app = FastAPI(
    title='测试',
    description='用于书籍仓储服务',
    version=version,
    lifespan=life_span
)


```
4. 接下来创建主程序入口  
根目录下的main.py   
```python
"""
@File    :main.py
@Editor  : 百年
@Date    :2026/2/9 16:58 
"""

from src import app
import uvicorn

if __name__ == '__main__':
    uvicorn.run(app,host='127.0.0.1',port=8080)



```

直接运行之后就会创建数据库了  
![img.png](img.png)  

5. 这样之后我们可以进行alembic的操作了   
- 进入项目目录,进行初始化  
```shell
alembic init alembic
```   
- 然后进行定制化数据库  
在alembic.ini中指定数据库连接
❗❗❗❗值得关注的就是这里了❗❗❗❗  
alembic进行数据库迁移等的操作的时候是不支持异步的,所以是用同步的driver psycopg2
要使用需要先安装
  
```bash 
pip install psycopg2-binary
```
- 接下来就是alembic.ini的数据库连接了
```text
sqlalchemy.url =postgresql+psycopg2://postgres:HHCzio20.@localhost:5432/fsdb

```  

- 除此之外还需要定义alembic\env.py中的内容  
也就是导入我们创建的ORM模型,又由于是通过继承Base来的,所以我们指定Base.metadata就可以了  

```python
from  src.models import Base
target_metadata =[Base.metadata]
```  

- 接下来就是迁移操作  
```bash
alembic revision --autogenerate -m "init commit"
alembic upgrade head
```  

这样之后查看，已经又版本文件了,迁移成功!!❗